<div class="content-header">

    <div class="con-head-left">
        <span placeholder="Soraqça" class="hed-title">Fənn kataloqları</span><span class="head-total"> <span
            data-student-count></span></span>
    </div>
    <div class="con-head-right">
        <div class="prepend-icon">
            <input id="subject_search" data-i18n="placeholder.search" type="search" class=" name-filter"
                   placeholder="search">

        </div>
        <div id="buttons_div" class="dropdown-func">
            <div class="btn btn-default reg dropdown-toggle cog" data-toggle="dropdown" aria-haspopup="true"
                 aria-expanded="false">
                Ümumi əməliyyatlar
            </div>
            <ul id="module_operations" class="dropdown-menu calibrated">

            </ul>
        </div>
    </div>
</div>
<div class="filters-block module_1000009">

    <div class="btn-group">
        <select class="form-control search-select" id="org_uni_filter">

        </select>
        <i class="fa fa-angle-down" style="position: absolute; top:9px; right: 14px; font-size: 14px"></i>
    </div>
    <div class="btn-group">
        <select class="form-control " id="org_faculty_filter">

        </select>
    </div>
    <div class="btn-group">
        <select class="form-control " id="org_kafedra_filter">

        </select>
    </div>

</div>
<form class="subject-catalog-search-form">
    <input type="hidden" name="orgId">
    <input type="hidden" name="keyword">
</form>
<!-- <form class="subject-catalog-search-form">
    <input type="hidden" name="orgId" />
    <input type="hidden" name ="keyword"/>
</form> -->
<!-- <div class="col-sm-12 content-filters">

    <div class="">
        <div class="col-sm-9 select-bar">
            <div class="form-group">
                <div class="btn-group">
                    <div class="tree-modal-container">
                        <button  id="org-list" type="button" class="btn btn-default group-tree-modal  btn-block"><span data-i18n="structure">Structure</span></button>

                    </div>
                </div>
            </div>

        </div>
        <div class="col-sm-2 search-bar">
            <div class="prepend-icon">
                <input id="subject_search" data-i18n="placeholder.search"  type="search" class="form-control input-sm m-l-10 name-filter" placeholder="search">
                <i class="fa fa-search m-l-10"></i>
            </div>

        </div>
        <div class="col-sm-1 button-bar">
            <div id="buttons_div" class="btn-group dropdown-func">
                <div class="btn btn-default reg dropdown-toggle cog" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                </div>
                <ul id="module_operations" class="dropdown-menu plus special">

                </ul>
            </div>
        </div>
    </div>

subject-catalog-subject

</div> -->

<div class="row ">
    <div class="col-md-12">
        <div class="panel panel-white table-scroll">
            <div class="table-responsive" style="overflow: hidden">
                <table id="subject-catalog-table" class="table table-celled table-hover long-last-td">
                    <thead>
                    <tr>
                        <th>№</th>
                        <th>Kafedra</th>
                        <th>Fənnin adı</th>
                        <th></th>
                    </tr>
                    </thead>

                    <tbody>

                    </tbody>
                </table>
                <div class="space-for-footer">
                    <div id="load_more_div" class="flex-input">
                        <button data-i18n="load.more" data-table="subject_catalog_module"
                                class="btn loading-margins btn-load-more">Daha çox yüklə
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- <div class="modal subject-catalog-modal">
    <div class="modal-dialog document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4  class="modal-title">Yeni Fənn Kataloqu</h4>
            </div>
            <div class="modal-body">
                <input subject-catalog-required class="structure-id hidden" name = "orgId" type="hidden" />
                <input class="structure-type-id hidden"/>
                <div class="form-group">
                    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="headingUniversity">
                                <h4 class="panel-title">
                                    <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseUniversity" aria-expanded="false" aria-controls="collapseUniversity">
                                        Kafedra
                                    </a>
                                    <h6 id="university-list-h6"></h6>
                                </h4>
                            </div>
                            <div id="collapseUniversity" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingUniversity">
                                <div class="panel-body scrollable tree-max-height org-list-accordion" id="org-list-accordion">

                                </div>
                            </div>
                        </div>

                    </div>

                </div>


                <div class="form-group">
                    <label for="add-serial">Fənn</label>
                    <div class="prepend-icon">
                        <select subject-catalog-required class="form-control subject-catalog-subject no-padding select-with-search" >

                        </select>
                    </div>
                </div>

            </div>
            <div class="modal-footer flex-img">
                <button data-i18n="buttons.ok" doc-confirm type="button" class="btn btn-primary btn-subject-catalog-submit">OK</button>
                <button data-i18n="cancel" type="button" class="btn btn-danger" data-dismiss="modal" aria-label="Close">Cancel</button>
            </div>
        </div>
    </div>
</div> -->

<div id="academicGroupTree" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-primary">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 data-i18n="university" class="modal-title">Ali təhsil müəssisəsi</h4>
            </div>
            <div class="modal-body scrollable">
                <div class="row">
                    <div class="col-xs-12">
                        <div class="search-bar">
                            <div class="prepend-icon">
                                <input data-i18n="placeholder.search" class="form-control input-sm tree-search"
                                       type="search" placeholder="Search">
                                <i class="fa fa-search"></i>
                            </div>
                        </div>
                        <div id="org-list-tree" style="overflow: auto;">

                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer flex-img">
                <button data-i18n="buttons.ok" type="button" class="btn btn-primary orgStructureFilter">OK</button>
            </div>
        </div>
    </div>
</div>
<div class="new-upd ems">
    <div class="search-scroll">
        <div class="">
            <div class="search-butons">
                <a data-i18n="buttons.ok" class="btn-subject-catalog-submit">OK</a>
                <a href="" data-i18n="close" class="close-student-search" placeholder="Bağla">Bağla</a>
            </div>
            <div class="ems-first-block">
                <h3 class="panel-title">Yeni Fənn Kataloqu</h3>
            </div>
            <div class="">
                <input subject-catalog-required class="structure-id hidden" name="orgId" type="hidden"/>
                <input class="structure-type-id hidden"/>
                <div class="form-group">
                    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="headingUniversity">
                                <h4 class="panel-title">
                                    <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion"
                                       href="#collapseUniversity" aria-expanded="false"
                                       aria-controls="collapseUniversity">
                                        Kafedra
                                    </a>
                                    <h6 id="university-list-h6"></h6>
                                </h4>
                            </div>
                            <div id="collapseUniversity" class="panel-collapse collapse" role="tabpanel"
                                 aria-labelledby="headingUniversity">
                                <div class="panel-body scrollable tree-max-height org-list-accordion"
                                     id="org-list-accordion">

                                </div>
                            </div>
                        </div>

                    </div>

                </div>


                <div class="form-group">
                    <label for="add-serial">Fənn</label>
                    <div class="">
                        <select subject-catalog-required class="form-control subject-catalog-subject no-padding">

                        </select>
                    </div>
                </div>

            </div>
            <!--             <div class="modal-footer flex-img">
                            <button data-i18n="buttons.ok" doc-confirm type="button" class="btn btn-primary btn-subject-catalog-submit">OK</button>
                            <button data-i18n="cancel" type="button" class="btn btn-danger" data-dismiss="modal" aria-label="Close">Cancel</button>
                        </div> -->
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function (e) {

        // $('body').find('.subject-catalog-subject-new').select2();


        $('body').find('.table-scroll').slimScroll();
        $('body').find('.search-select').select2();
        $('body').on('click', '.close-student-search', function () {
            $('body').find('.new-upd').css('right', '-100%');
            return true
        });


        // $('.subject-catalog-modal').on('shown.bs.modal', function () {
        //     $('body').find('.select-with-search').select2({
        //         theme: 'bootstrap'
        //     });
        // });


        $('.subject-catalog-modal').on('hidden.bs.modal', function () {
            $('body').find('.subject-catalog-modal .structure-id, .subject-catalog-modal .subject-catalog-subject').removeClass('blank-required-field');
        });

        try {
            Ems.i18n(Ems.lang);
            $('#main-div .sub_modules_div').remove();
            Ems.Proxy.loadOperations(Ems.currModule, function (operations) {
                $('#buttons_div').find('ul').html(Ems.Service.parseOperations(operations, 1));
                Ems.Proxy.getSubjectCatalogList();
            });

            Ems.Proxy.loadOrgTreeByType(1000074, function (tree) {
                Ems.Service.commonParseTree(tree, 'org-list-accordion');
            }, $('#org-list-accordion'));

            Ems.Proxy.loadDictionariesByTypeId(1000038, 0, function (subject) {
                $('.subject-catalog-subject').html(Ems.Service.parseDictionaryForSelect(subject));
                $('body').find('.subject-catalog-subject').select2();
            });

            $('#main-div').on('click', '#org-list', function (event) {
                try {
                    $('#academicGroupTree').modal({
                        backdrop: false
                    });

                    var treeObj = $(':jstree').length;
//                if (treeObj == 0) {
                    if ($('#org-list-tree').attr('check') !== '1') {
                        Ems.Proxy.loadOrgTreeByType(1000074, function (tree) {
                            Ems.Service.commonParseTree(tree, 'org-list-tree');
                            $('.tree-preloader').remove();
                        }, $('#org-list-tree'));
                        var searchString = $('#main-div .tree-search').val();
                        $('#org-list-tree').jstree('search', searchString);
                    }
//                }
                    ;

                }
                catch (err) {
                    console.error(err);
                }
            });

            $(".tree-search").keyup(function () {
                var searchString = $(this).val();
                $('#org-list-tree').jstree('search', searchString);
            });

            $('.orgStructureFilter').on('click', function (e) {
                try {
                    var id = $('#org-list-tree li[aria-selected="true"]').attr('id');
                    var text = $('#org-list-tree li[aria-selected="true"]').find('a:first').text();
                    if (text.length > 0) {
                        $('.btn.group-tree-modal').text(text);
                        $('.btn.group-tree-modal').attr('data-id', id);
                        $('#academicGroupTree').modal('hide');

                        if (id !== 0) {
                            $('body .subject-catalog-search-form input[name="orgId"]').val(id);
                        }
                        else {
                            $('body .subject-catalog-search-form input[name="orgId"]').val('');
                        }
                        var params = $('body .subject-catalog-search-form').serialize();
                        Ems.Proxy.getSubjectCatalogList('', params);
                        $('.btn-load-more').removeAttr('data-page');
                    }
                    else {
                        $.notify(Ems.dictionary[Ems.lang]['select_information'], {
                            type: 'warning'
                        })
                    }
                }
                catch (err) {

                }
            });


            $("#main-div #org-list-accordion").on("select_node.jstree", function (evt, data) {
                try {
                    var path = data.instance.get_path(data.node, ',');
                    $('#headingOne').attr('data-node-id', data.node.id);
                    $('#headingOne').attr('data-node-text', path);
                    $('#university-list-h6').text(path);
                    if (data.node.id > 0) {
                        $('#main-div .structure-id').val(data.node.id);
                        $('#main-div .structure-id').removeClass('blank-required-field');
                    }
                    $('#main-div .structure-type-id').val(data.node.original.typeId);

                }
                catch (err) {
                    console.error(err);
                }
            });


            $('body').on('keypress', '#subject_search', function (e) {
                try {

                    if (e.keyCode == 13) {
                        var keyword = $('#subject_search').val();

                        var queryparams = '';
                        if (keyword.trim().length > 2) {
                            $('.btn-load-more').removeAttr('data-page');
                            $('.subject-catalog-search-form input[name="keyword"]').val(keyword);
                            queryparams = $('body .subject-catalog-search-form').serialize();
                            Ems.Proxy.getSubjectCatalogList('', queryparams);
                        }
                        else if (keyword.trim().length == 0) {
                            $('.btn-load-more').removeAttr('data-page');
                            $('.subject-catalog-search-form input[name="keyword"]').val('');
                            queryparams = $('body .subject-catalog-search-form').serialize();
                            Ems.Proxy.getSubjectCatalogList('', queryparams);
                            ;
                        }
                    }

                }
                catch (err) {
                    console.error(err);
                }
            });



        }
        catch (err) {
            console.error(err);
        }


        Ems.Proxy.getStructureListByFilter(0, 0, function (data) {
            if (data && data.data) {
                var html = '';
                var uni = data.data.universityList;
                var faculty = data.data.facultyList;
                var spec = data.data.specialityList;
                var uniCount = data.data.universityList.length;
                var facultyCount = data.data.facultyList.length;
                var specCount = data.data.specialityList.length;
                var departmentList = data.data.departmentList.length;

                if (uniCount <= 1) {
                    $('#org_uni_filter').attr('disabled', 'disabled')
                    $.each(uni, function (i, v) {
                        html += '<option value = "' + v.id + '">' + v.name[Ems.lang] + '</option>'
                    })
                    $('#org_uni_filter').html(html)
                } else {
                    html = '<option value = "0">Universitet</option>'
                    $.each(uni, function (i, v) {
                        html += '<option value = "' + v.id + '">' + v.name[Ems.lang] + '</option>'
                    })
                    $('#org_uni_filter').html(html)
                }
                if (facultyCount <= 1) {
                    html = '';
                    $('#org_faculty_filter').attr('disabled', 'disabled')
                    // $.each(faculty, function(i, v){
                    //     html += '<option value = "'+v.id+'">'+v.name[Ems.lang]+'</option>'
                    // })
                    $('#org_faculty_filter').html(html)
                } else {
                    html = '<option value = "0">Fakültə</option>'
                    // $.each(faculty, function(i, v){
                    //     html += '<option value = "'+v.id+'">'+v.name[Ems.lang]+'</option>'
                    // })
                    $('#org_faculty_filter').html(html)
                }
                if (departmentList <= 1) {
                    html = '';
                    $('#org_kafedra_filter').attr('disabled', 'disabled')
                    $.each(departmentList, function (i, v) {
                        html += '<option value = "' + v.id + '">' + v.name[Ems.lang] + '</option>'
                    })
                    $('#org_kafedra_filter').html(html)
                } else {
                    html = '<option value = "0">Kafedra</option>'
                    $.each(departmentList, function (i, v) {
                        html += '<option value = "' + v.id + '">' + v.name[Ems.lang] + '</option>'
                    })
                    $('#org_kafedra_filter').html(html)
                }
                if (specCount <= 1) {
                    html = '';
                    $('#org_spec_filter').attr('disabled', 'disabled')
                    $.each(spec, function (i, v) {
                        html += '<option value = "' + v.id + '">' + v.name[Ems.lang] + '</option>'
                    })
                    $('#org_spec_filter').html(html)
                } else {
                    html = '<option value = "0">İxtisas</option>'
                    $.each(spec, function (i, v) {
                        html += '<option value = "' + v.id + '">' + v.name[Ems.lang] + '</option>'
                    })
                    $('#org_spec_filter').html(html)
                }


            }

        });

        $('#org_uni_filter').on('change', function () {
            var id = $(this).val();
            var text = $(this).find('option:selected').text();
            var levelId = $('#org_spec_level_filter').val();

            Ems.Proxy.getStructureListByFilter(id, levelId, function (data) {
                if (data && data.data) {
                    var html = '';
                    var faculty = data.data.facultyList;
                    var spec = data.data.specialityList;
                    var departmentList = data.data.departmentList;

                    html = '<option value = "0">Fakültə</option>'
                    $.each(faculty, function (i, v) {
                        html += '<option value = "' + v.id + '">' + v.name[Ems.lang] + '</option>'
                    })
                    $('#org_faculty_filter').html(html)


                    html = '<option value = "0">İxtisas səviyyəsi</option>'
                    $.each(spec, function (i, v) {
                        html += '<option value = "' + v.id + '">' + v.name[Ems.lang] + '</option>'
                    })
                    $('#org_spec_filter').html(html)

                    html = '<option value = "0">Kafedra</option>'
                    $.each(departmentList, function (i, v) {
                        html += '<option value = "' + v.id + '">' + v.name[Ems.lang] + '</option>'
                    })
                    $('#org_kafedra_filter').html(html)

                    if (id != 1000001 || id != 0) {
                        $('.main-content-upd .subject-catalog-search-form input[name="orgId"]').val(id);
                    }
                    else {
                        $('.main-content-upd .subject-catalog-search-form input[name="orgId"]').val('');
                    }

                    $('.btn-load-more').removeAttr('data-page');
                    var queryparams = $('.main-content-upd .subject-catalog-search-form').serialize();

                    Ems.Proxy.getSubjectCatalogList('', queryparams);

                }
            })

        });

        $('#org_faculty_filter').on('change', function () {
            var facultyId = $(this).val();
            var uniId = $('#org_uni_filter').val();
            var uniname = $('#org_uni_filter').find('option:selected').text();
            var facultyName = $(this).find('option:selected').text();
            var levelId = $('#org_spec_level_filter').val();
            var id = facultyId == 0 ? uniId : facultyId
            var text = facultyId == 0 ? uniname : facultyName

            Ems.Proxy.getStructureListByFilter(id, levelId, function (data) {
                if (data && data.data) {
                    var html = '';
                    var spec = data.data.specialityList;
                    var departmentList = data.data.departmentList;

                    html = '<option value = "0">Hamısı</option>'
                    $.each(spec, function (i, v) {
                        html += '<option value = "' + v.id + '">' + v.name[Ems.lang] + '</option>'
                    })
                    $('#org_spec_filter').html(html)

                    html = '<option value = "0">Hamısı</option>'
                    $.each(departmentList, function (i, v) {
                        html += '<option value = "' + v.id + '">' + v.name[Ems.lang] + '</option>'
                    })
                    $('#org_kafedra_filter').html(html)

                    if (id != 0) {
                        $('.main-content-upd .subject-catalog-search-form input[name="orgId"]').val(id);
                    }
                    else {
                        $('.main-content-upd .subject-catalog-search-form input[name="orgId"]').val('');
                    }

                    $('.btn-load-more').removeAttr('data-page');
                    var queryparams = $('.main-content-upd .subject-catalog-search-form').serialize();
                    Ems.Proxy.getSubjectCatalogList('', queryparams);

                }
            })

        });

        $('#org_spec_level_filter').on('change', function () {
            var levelId = $(this).val();
            var uniId = $('#org_uni_filter').val();
            var uniName = $('#org_uni_filter').find('option:selected').text();
            var facultyId = $('#org_faculty_filter').val();
            var facultyName = $('#org_faculty_filter').find('option:selected').text();

            var id = facultyId == 0 ? uniId : facultyId;
            var text = facultyId == 0 ? uniName : facultyName;

            Ems.Proxy.getStructureListByFilter(id, levelId, function (data) {
                if (data && data.data) {
                    var html = '';
                    var spec = data.data.specialityList;

                    html = '<option value = "0">İxtisas səviyyəsi</option>'
                    $.each(spec, function (i, v) {
                        html += '<option value = "' + v.id + '">' + v.name[Ems.lang] + '</option>'
                    })

                }
            })

        });

        $('#org_kafedra_filter').on('change', function () {
            var kafedraId = $(this).val();
            var kafedraName = $(this).find('option:selected').text();
            var uniId = $('#org_uni_filter').val();
            var uniName = $('#org_uni_filter').find('option:selected').text();
            var facultyId = $('#org_faculty_filter').val();
            var facultyName = $('#org_faculty_filter').find('option:selected').text();
            var id = kafedraId == 0 ? (facultyId == 0 ? uniId : facultyId) : kafedraId;
            var text = kafedraId == 0 ? (facultyId == 0 ? uniName : facultyName) : kafedraName;


            if (id != 0) {
                $('.main-content-upd .subject-catalog-search-form input[name="orgId"]').val(id);
            }
            else {
                $('.main-content-upd .subject-catalog-search-form input[name="orgId"]').val('');
            }

            $('.btn-load-more').removeAttr('data-page');
            var queryparams = $('.main-content-upd .subject-catalog-search-form').serialize();
            Ems.Proxy.getSubjectCatalogList('', queryparams);

        });


    });

    /*function getDataFilter() {
        var keyword = $('#subject_search').val();
        var queryparams = '';
        $('.btn-load-more').removeAttr('data-page');
        $('.subject-catalog-search-form input[name="keyword"]').val(keyword);
        queryparams = $('body .subject-catalog-search-form').serialize();
        Ems.Proxy.getSubjectCatalogList('', queryparams);
    }*/
</script>


